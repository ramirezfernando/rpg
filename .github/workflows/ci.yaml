name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  SDL3_VERSION: "3.2.14"
  SDL3_IMAGE_VERSION: "3.0.4"
  SDL3_INSTALL_PREFIX: ${{ github.workspace }}/.sdl3

jobs:
  # 1. Build & cache SDL3 + SDL3_image.
  build-sdl3:
    name: Build SDL3 dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Cache SDL3
        id: cache-sdl3
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.sdl3
          key: sdl3-${{ env.SDL3_VERSION }}-sdl3image-${{ env.SDL3_IMAGE_VERSION }}-ubuntu

      - name: Install build tools
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y cmake ninja-build \
            libpng-dev libjpeg-dev libwebp-dev

      - name: Build SDL3
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/libsdl-org/SDL/releases/download/release-${{ env.SDL3_VERSION }}/SDL3-${{ env.SDL3_VERSION }}.tar.gz
          tar xf SDL3-${{ env.SDL3_VERSION }}.tar.gz
          cmake -S SDL3-${{ env.SDL3_VERSION }} -B sdl3-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ env.SDL3_INSTALL_PREFIX }} \
            -DSDL_TESTS=OFF \
            -DSDL_EXAMPLES=OFF
          cmake --build sdl3-build --parallel
          cmake --install sdl3-build

      - name: Build SDL3_image
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/libsdl-org/SDL_image/releases/download/release-${{ env.SDL3_IMAGE_VERSION }}/SDL3_image-${{ env.SDL3_IMAGE_VERSION }}.tar.gz
          tar xf SDL3_image-${{ env.SDL3_IMAGE_VERSION }}.tar.gz
          cmake -S SDL3_image-${{ env.SDL3_IMAGE_VERSION }} -B sdl3image-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ env.SDL3_INSTALL_PREFIX }} \
            -DSDL3_DIR=${{ env.SDL3_INSTALL_PREFIX }}/lib/cmake/SDL3 \
            -DSDL3IMAGE_TESTS=OFF \
            -DSDL3IMAGE_SAMPLES=OFF
          cmake --build sdl3image-build --parallel
          cmake --install sdl3image-build

  # 2. Run `clang-tidy` static analysis.
  tidy:
    name: clang-tidy
    runs-on: ubuntu-latest
    needs: build-sdl3

    steps:
      - uses: actions/checkout@v4

      - name: Restore SDL3 cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.sdl3
          key: sdl3-${{ env.SDL3_VERSION }}-sdl3image-${{ env.SDL3_IMAGE_VERSION }}-ubuntu

      - name: Install clang-tidy
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y clang clang-tidy pkg-config

      - name: Run clang-tidy
        run: |
          export PKG_CONFIG_PATH=${{ env.SDL3_INSTALL_PREFIX }}/lib/pkgconfig

          SRCS=$(find src -name "*.cpp" | tr '\n' ' ')
          SDL3_INCLUDES="-isystem $(pkg-config --variable=includedir sdl3)"
          CXXFLAGS="-std=c++23 -Isrc $SDL3_INCLUDES \
            -Wall -Weffc++ -Wextra -Wconversion \
            -Wsign-conversion -Wimplicit-fallthrough -Werror"

          clang-tidy --header-filter='src/.*' $SRCS -- $CXXFLAGS

  # 3. Build.
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: build-sdl3

    steps:
      - uses: actions/checkout@v4

      - name: Restore SDL3 cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.sdl3
          key: sdl3-${{ env.SDL3_VERSION }}-sdl3image-${{ env.SDL3_IMAGE_VERSION }}-ubuntu

      - name: Install clang & pkg-config
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y clang pkg-config

      - name: Compile and link
        run: |
          export PKG_CONFIG_PATH=${{ env.SDL3_INSTALL_PREFIX }}/lib/pkgconfig
          export LD_LIBRARY_PATH=${{ env.SDL3_INSTALL_PREFIX }}/lib

          SDL3_INCLUDES="-isystem $(pkg-config --variable=includedir sdl3)"
          CXXFLAGS="-std=c++23 -Isrc $SDL3_INCLUDES \
            -Wall -Weffc++ -Wextra -Wconversion \
            -Wsign-conversion -Wimplicit-fallthrough -Werror"
          LDFLAGS="$(pkg-config --libs sdl3) $(pkg-config --libs sdl3-image) \
            -Wl,-rpath,${{ env.SDL3_INSTALL_PREFIX }}/lib"

          # Compile
          SRCS=$(find src -name "*.cpp")
          for src in $SRCS; do
            obj="${src%.cpp}.o"
            echo "  CC  $src"
            clang++ $CXXFLAGS -c "$src" -o "$obj"
          done

          # Link
          mkdir -p out
          OBJS=$(find src -name "*.o" | tr '\n' ' ')
          echo "  LD  out/play"
          clang++ $OBJS -o out/play $LDFLAGS

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: play-linux
          path: out/play
          retention-days: 7